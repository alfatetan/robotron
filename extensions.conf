[zadarma-in]

	;назначаем основные переменные:
	;sayfile - содержит имя файла, проигрываемого системой
	;scheme - содержит имя папки сценария диалога
	;sayindex - содержит текущую позицию диалога, по которой происходит этот цикл
	;voicefile - имя файла, где записан голос абонента
	;audiorec - преамбула файла голоса абонента (voicefile)
	;count - счетчик для формирования voicefile
	;skip - пропустить выслушивание абонента: просто сказать и перейти в следующий цикл. Следующий блок как раз и находится в skip. Если skip = 0, то работа в штатном режиме.
	;waitvoice - ожидание ответа от абонента определённое время в миллисекундах. 0 - бесконечно ждём
exten => 590889, 1, Set(audiorec=unknown_voice)
exten => 590889, n, Set(count=0)
exten => 590889, n, Set(sayindex=0)
exten => 590889, n, Set(scheme=default)
exten => 590889, n, Set(sayfile=_begin)
exten => 590889, n, Set(skip=0)
exten => 590889, n, Set(waitvoice=0)
exten => 590889, n, Set(voicefile=${audiorec}-${count})



      ;берём трубку
exten => 590889, n, Answer()

;Перебиваем переменные, принятые по умолчанию на те что были в .call файле
exten => 590889, n, AGI(/var/lib/asterisk/agi-bin/preparation.agi)

;--------------- ВРЕМЕННО ДЕАКТИВИРОВАННЫЙ КУСОК КОДА -----------------
	;один из вариантов - запустить запись перед началом разговора. Нужно тестировать какой более эффективен
;exten => 590889, 4, Monitor(wav, clientvoice, o) ; Чтобы уменьшить задержку, необходимо два раза включать монитор
;один раз после произнесения звука, второй раз - если абонент перебил. Обратить внимание на приоритеты!
;----------------------------------------------------------------------

	;произносим пламенную речь и даём возможность перебить абоненту
;exten => 590889,n(sayanything),BackgroundDetect(my/name, 150)
;exten => 590889,n(sayanything),BackgroundDetect(my/${sayfile})
exten => 590889,n(sayanything),Background(${scheme}/${sayfile})

	;если нам нужно не слушать абонента, пропускаем диалог
exten => 590889, n, GotoIf($[${skip} = 0]?:skiplisng)

	;выставляем название файла
exten => 590889,n,Set(count=$[${count} + 1])
exten => 590889,n,Set(voicefile=${audiorec}-${count})

	;чтобы ускоротить запись, начинаем её под конец произношения нашей пламенной речи. Т.о. файл будет короче
exten => 590889, n, Monitor(wav,${voicefile}, o)

	;нас выслушали, теперь мы ожидаем когда абонент начнёт говорить. 0 - бесконечно молчим в секундах
exten => 590889, n, WaitForNoise(150, 1, ${waitvoice})


	;пока наш абонент говорит, мы ждём, пока он не замолчит на секунду с четвертью.
	;при более развёрнутых ответах лучше увеличивать паузу, а при более простых
	;например да/нет, лучше уменьшать ожидание тишины
;exten => 590889, n, WaitForSilence(1250, 1, 0, 150)
exten => 590889, n, WaitForSilence(350, 1, 0)

	;записываем полученный разговор в новый файл
;exten => 590889, n, Set(count=$[${count} + 1])
;exten => 590889, n, Set(voicefile=${prefix}-${count})
;exten => 590889, n, ChangeMonitor(${voicefile})
exten => 590889, n, StopMonitor()

      ;если был переход без выслушивания, то возвращаем выслушивание для следующего блока
exten => 590889, n(skiplisng), Set(skip=0)

	;запускаем внешний обработчик, в итоге получаем относительно DialPlan:
	;STDOUT: куча всякой ненужной хрени, sayindex, saybranch, voicefile
	;STDIN: sayfile, scheme, sayindex
exten => 590889, n, AGI(/var/lib/asterisk/agi-bin/say_agi_robotron.agi)

	;проверяем, если sayfile содержит _end, то завершаем разговор
exten => 590889, n, GotoIf($[${sayfile}=_end]?endtalk:sayanything)

exten => 590889, n(endtalk), SendDTMF(123) ; временный сигнал для отладки, что всё прошло как нужно. После отладки можно удалить или закомментировать

	;разговор окончен, разъединяем. После отладки необходимо заменить на закомментированную строку
;exten => 590889, n(endtalk), Hangup()
exten => 590889, n, Hangup()

;----Временно неактивный кусок кода. Требуется доработка------

	;если абонент любит перебивать (эту часть необходимо доработать 2019.05.17):
exten => talk, 1, Monitor(wav, clientvoice, o)
exten => talk, n, Playback(my/aga.wav)
exten => 590889, n, WaitForSilence(2000, 1, 3) ; ждём пока абонент замолчит на 2 секунды
exten => 590889, n, ChangeMonitor(${nextfname})
exten => 590889, n, StopMonitor()
exten => 590887, Goto(sayanything)
	;!!!!!здесь, по логике вещей - должен висеть внешний обработчик 

;------------------------------------------------------------

[zadarma-out]
exten => _XXX,1,Dial(SIP/${EXTEN})                     ; звонки на трехзначные внутренние номера aстериска
exten => _XXX.,1,Dial(SIP/${EXTEN}@590889)             ; звонки на номера в которых четрые и более цифр через транк 590889

[calls]
